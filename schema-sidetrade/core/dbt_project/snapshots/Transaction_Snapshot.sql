{% snapshot transaction_snapshot %}

{{
    config(
      target_schema=env_var('SNOWFLAKE_SCHEMA'),
      unique_key='ITEM_TECHNICAL_NUMBER',
      strategy='check',
      check_cols=['ROW_HASH'],
      updated_at='EXTRACTION_DATE'
    )
}}

SELECT
    -- ROW_HASH for faster change data capture
    md5(concat_ws('|',
    -- coalesce(EXTRACTION_DATE, ''),
    coalesce(RECORD_TYPE, ''),
    coalesce(TECHNICAL_BUYER_CODE, ''),
    coalesce(FUNCTIONAL_BUYER_CODE, ''),
    coalesce(TECHNICAL_PAYMENT_CENTER_CODE, ''),
    coalesce(FUNCTIONAL_PAYMENT_CENTER_CODE, ''),
    coalesce(PAYMENT_CENTER_ENTITY_CODE, ''),
    coalesce(PAYMENT_CENTER_ENTITY_NAME, ''),
    -- coalesce(ITEM_TECHNICAL_NUMBER, ''),
    coalesce(ITEM_FUNCTIONAL_NUMBER, ''),
    coalesce(ITEM_DATE, ''),
    coalesce(DUE_DATE, ''),
    coalesce(ITEM_CURRENCY, ''),
    coalesce(DEBIT_OR_CREDIT, ''),
    coalesce(INITIAL_AMOUNT_INCLUDING_TAXES_IN_TRANSACTION_CURRENCY, ''),
    coalesce(INITIAL_AMOUNT_INCLUDING_TAXES_IN_ACCOUNTING_CURRENCY_USD, ''),
    coalesce(REMAINING_AMOUNT_IN_TRANSACTION_CURRENCY_, ''),
    coalesce(REMAINING_AMOUNT_IN_ACCOUNTING_CURRENCY_, ''),
    coalesce(LATEST_BALANCE_CHANGE_TECHNICAL_DATE, ''),
    coalesce(LATEST_BALANCE_CHANGE_PAYMENT_RECEIPT_DATE, ''),
    coalesce(BALANCE_TO_ZERO_TECHNICAL_DATE, ''),
    coalesce(BALANCE_TO_ZERO_PAYMENT_RECEIPT_DATE, ''),
    coalesce(ITEM_REFERENCE, ''),
    coalesce(METHOD_OF_PAYMENT_CODE, ''),
    coalesce(METHOD_OF_PAYMENT_LABEL, ''),
    coalesce(ORDER_NUMBER, ''),
    coalesce(ORDER_DATE, ''),
    coalesce(STATEMENT_NUMBER, ''),
    coalesce(REJECTED_PAYMENT_DATE, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_1, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_2, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_3, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_4, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_5, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_6, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_7, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_8, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_9, ''),
    coalesce(ITEM_ASSIGNMENT_CODE_10, ''),
    coalesce(INITIAL_AMOUNT_WITHOUT_TAXES_IN_TRANSACTION_CURRENCY, ''),
    coalesce(INITIAL_AMOUNT_WITHOUT_TAXES_IN_ACCOUNTING_CURRENCY, ''),
    coalesce(REMAINING_AMOUNT_WITHOUT_TAXES_IN_TRANSACTION_CURRENCY, ''),
    coalesce(REMAINING_AMOUNT_WITHOUT_TAXES_IN_ACCOUNTING_CURRENCY, ''),
    coalesce(ITEM_LOCAL_CURRENCY_CODE, ''),
    coalesce(INITIAL_AMOUNT_IN_LOCAL_CURRENCY, ''),
    coalesce(REMAINING_AMOUNT_IN_LOCAL_CURRENCY, ''),
    coalesce(INITIAL_AMOUNT_WITHOUT_TAXES_IN_LOCAL_CURRENCY, ''),
    coalesce(REMAINING_AMOUNT_WITHOUT_TAXES_IN_LOCAL_CURRENCY, ''),
    coalesce(CAN_BE_LEADER_INVOICE, ''),
    coalesce(IS_LEADING_INVOICE, ''),
    coalesce(STATUS_CODE, ''),
    coalesce(STATUS_INTERNAL_NAME, ''),
    coalesce(SUB_STATUS_CODE, ''),
    coalesce(SUB_STATUS_INTERNAL_NAME, ''),
    coalesce(STATUS_DATE, ''),
    coalesce(STATUS_RESOLVER, ''),
    coalesce(PROMISE_OF_PAYMENT_DATE, ''),
    coalesce(STATUS_DETAILS, ''),
    coalesce(STATUS_UPDATED_BY, ''),
    coalesce(COMMENT_DATE, ''),
    coalesce(COMMENT_AUTHOR, ''),
    coalesce(COMMENT, ''),
    coalesce(NEXT_ACTION_CODE, ''),
    coalesce(NEXT_ACTION_DATE, ''),
    coalesce(COLLECTOR_IN_CHARGE, ''),
    coalesce(PRIMARY_CPA_CONTACT_NAME, ''),
    coalesce(PRIMARY_CPA_CONTACT_EMAIL, ''),
    coalesce(PRIMARY_CPA_CONTACT_PHONE, ''),
    coalesce(ITEMS_LATE_DELAYS, ''),
    coalesce(PAYMENT_CENTER_NAME, ''),
    coalesce(BUYER_NAME, ''),
    coalesce(CPA_ASSIGNMENT_CODE_1, ''),
    coalesce(CPA_ASSIGNMENT_CODE_2, ''),
    coalesce(CPA_ASSIGNMENT_CODE_3, ''),
    coalesce(CPA_ASSIGNMENT_CODE_4, ''),
    coalesce(CPA_ASSIGNMENT_CODE_5, ''),
    coalesce(CPA_ASSIGNMENT_CODE_6, ''),
    coalesce(CPA_ASSIGNMENT_CODE_7, ''),
    coalesce(CPA_ASSIGNMENT_CODE_8, ''),
    coalesce(CPA_ASSIGNMENT_CODE_9, ''),
    coalesce(CPA_ASSIGNMENT_CODE_10, ''),
    coalesce(ITEM_CLEARING_DATE, ''),
    coalesce(CPA_COLLECTION_SIDEGROUP_CODE, ''),
    coalesce(CPA_COLLECTION_SIDEGROUP_NAME, ''),
    coalesce(LAST_COMPLETED_WORKFLOW_ACTION_CODE, ''),
    coalesce(LAST_COMPLETED_WORKFLOW_ACTION_NAME, ''),
    coalesce(LAST_COMPLETED_WORKFLOW_ACTION_COMPLETED_DATE, ''),
    coalesce(WORKFLOW_CODE, ''),
    coalesce(WORKFLOW_NAME, '')
    -- coalesce(LAST_UPDATED_DATETIME, '')
  )) as ROW_HASH,
    EXTRACTION_DATE,
    RECORD_TYPE,
    TECHNICAL_BUYER_CODE,
    FUNCTIONAL_BUYER_CODE,
    TECHNICAL_PAYMENT_CENTER_CODE,
    FUNCTIONAL_PAYMENT_CENTER_CODE,
    PAYMENT_CENTER_ENTITY_CODE,
    PAYMENT_CENTER_ENTITY_NAME,
    ITEM_TECHNICAL_NUMBER,
    ITEM_FUNCTIONAL_NUMBER,
    ITEM_DATE,
    DUE_DATE,
    ITEM_CURRENCY,
    DEBIT_OR_CREDIT,
    INITIAL_AMOUNT_INCLUDING_TAXES_IN_TRANSACTION_CURRENCY,
    INITIAL_AMOUNT_INCLUDING_TAXES_IN_ACCOUNTING_CURRENCY_USD,
    REMAINING_AMOUNT_IN_TRANSACTION_CURRENCY_,
    REMAINING_AMOUNT_IN_ACCOUNTING_CURRENCY_,
    LATEST_BALANCE_CHANGE_TECHNICAL_DATE,
    LATEST_BALANCE_CHANGE_PAYMENT_RECEIPT_DATE,
    BALANCE_TO_ZERO_TECHNICAL_DATE,
    BALANCE_TO_ZERO_PAYMENT_RECEIPT_DATE,
    ITEM_REFERENCE,
    METHOD_OF_PAYMENT_CODE,
    METHOD_OF_PAYMENT_LABEL,
    ORDER_NUMBER,
    ORDER_DATE,
    STATEMENT_NUMBER,
    REJECTED_PAYMENT_DATE,
    ITEM_ASSIGNMENT_CODE_1,
    ITEM_ASSIGNMENT_CODE_2,
    ITEM_ASSIGNMENT_CODE_3,
    ITEM_ASSIGNMENT_CODE_4,
    ITEM_ASSIGNMENT_CODE_5,
    ITEM_ASSIGNMENT_CODE_6,
    ITEM_ASSIGNMENT_CODE_7,
    ITEM_ASSIGNMENT_CODE_8,
    ITEM_ASSIGNMENT_CODE_9,
    ITEM_ASSIGNMENT_CODE_10,
    INITIAL_AMOUNT_WITHOUT_TAXES_IN_TRANSACTION_CURRENCY,
    INITIAL_AMOUNT_WITHOUT_TAXES_IN_ACCOUNTING_CURRENCY,
    REMAINING_AMOUNT_WITHOUT_TAXES_IN_TRANSACTION_CURRENCY,
    REMAINING_AMOUNT_WITHOUT_TAXES_IN_ACCOUNTING_CURRENCY,
    ITEM_LOCAL_CURRENCY_CODE,
    INITIAL_AMOUNT_IN_LOCAL_CURRENCY,
    REMAINING_AMOUNT_IN_LOCAL_CURRENCY,
    INITIAL_AMOUNT_WITHOUT_TAXES_IN_LOCAL_CURRENCY,
    REMAINING_AMOUNT_WITHOUT_TAXES_IN_LOCAL_CURRENCY,
    CAN_BE_LEADER_INVOICE,
    IS_LEADING_INVOICE,
    STATUS_CODE,
    STATUS_INTERNAL_NAME,
    SUB_STATUS_CODE,
    SUB_STATUS_INTERNAL_NAME,
    STATUS_DATE,
    STATUS_RESOLVER,
    PROMISE_OF_PAYMENT_DATE,
    STATUS_DETAILS,
    STATUS_UPDATED_BY,
    COMMENT_DATE,
    COMMENT_AUTHOR,
    COMMENT,
    NEXT_ACTION_CODE,
    NEXT_ACTION_DATE,
    COLLECTOR_IN_CHARGE,
    PRIMARY_CPA_CONTACT_NAME,
    PRIMARY_CPA_CONTACT_EMAIL,
    PRIMARY_CPA_CONTACT_PHONE,
    ITEMS_LATE_DELAYS,
    PAYMENT_CENTER_NAME,
    BUYER_NAME,
    CPA_ASSIGNMENT_CODE_1,
    CPA_ASSIGNMENT_CODE_2,
    CPA_ASSIGNMENT_CODE_3,
    CPA_ASSIGNMENT_CODE_4,
    CPA_ASSIGNMENT_CODE_5,
    CPA_ASSIGNMENT_CODE_6,
    CPA_ASSIGNMENT_CODE_7,
    CPA_ASSIGNMENT_CODE_8,
    CPA_ASSIGNMENT_CODE_9,
    CPA_ASSIGNMENT_CODE_10,
    ITEM_CLEARING_DATE,
    CPA_COLLECTION_SIDEGROUP_CODE,
    CPA_COLLECTION_SIDEGROUP_NAME,
    LAST_COMPLETED_WORKFLOW_ACTION_CODE,
    LAST_COMPLETED_WORKFLOW_ACTION_NAME,
    LAST_COMPLETED_WORKFLOW_ACTION_COMPLETED_DATE,
    WORKFLOW_CODE,
    WORKFLOW_NAME,
    LAST_UPDATED_DATETIME
FROM {{ ref('Transaction_Current_State') }}

{% endsnapshot %}